class Colaborador < ActiveRecord::Base
	has_many :cfue, primary_key: :codigo, foreign_key: :colaborador_codigo

	#conexão com a tabela colaboradores do portaldigital
	establish_connection "colaboradores_#{Rails.env}"

	devise 	:database_authenticatable, 
					:registerable, 
					:rememberable, 
					:recoverable,
					:trackable, 
					:validatable,
					:authentication_keys => [:pessoa_fisica_cpf, :ativo]

	def email_required?
		false
	end

	# verifica se o colaborador tem a função necessaria para acessar o sistema.
	def active_for_authentication?
  	(super && get_permissao) and get_tempo_acesso
	end

	def inactive_message
	  get_tempo_acesso ? super : "Seu prazo de tempo de acesso para o sistema expirou, favor renovar."
	  get_permissao ? super : "Você não tem permissão para acessar o sistema."
	end
	
	def get_permissao
		area = Cfue.where(["pessoa_fisica_cpf = ? and ativo = ?", self.pessoa_fisica_cpf, true]).pluck(:unidade_exercicio_descricao)
		(self.cfue.where(ativo: true, funcao_descricao: "Defensor Público").exists? and area.include? 'NUAPP') || (self.cfue.where(ativo: true, funcao_descricao: "Operador SIC").exists? and area.include? 'NUAPP') || self.pessoa_fisica_cpf == "02210439345"
	end

	def get_permissao_acesso
		PermissaoAcesso.find_by_cpf(self.pessoa_fisica_cpf)
	end

	def get_tempo_acesso
		if self.cfue.where(ativo: true, funcao_descricao: "Defensor Público", unidade_exercicio_descricao: "NUAPP").exists?
			#não tem tempo de acesso limitado
			#raise self.cfue.where(ativo: true, funcao_descricao: "Defensor Público", unidade_exercicio_descricao: "NUAPP").inspect
			#raise "1"
			return true
		elsif self.cfue.where(ativo: true, funcao_descricao: "Operador SIC").exists?
			@permissao = PermissaoAcesso.where(cpf: self.pessoa_fisica_cpf)
			if @permissao.present? and @permissao[0].data > Date.today
				#raise "2"
				return true
			else
				#raise "3"
				return false
			end
		else
			#raise "4"
			#sem permissão pra acessar o sistema
			false
		end
	end	

	# metodo para validar password encriptografados pelos sitemas antigos	
	def valid_password?(password)
		if self.legacy_password?
			# Use Devise's secure_compare to avoid timing attacks
			if Devise.secure_compare(self.senha, Colaborador.legacy_password(password)) 
				self.password = password
				self.password_confirmation = password
				self.legacy_password = false
				self.save!
			else
				return false
			end
		end

		super(password)
	end
	
 	# algoritimo de criptografia usado nas senhas antigas dos colaboradores
	def self.legacy_password(password)
		return Digest::SHA1.hexdigest("--#{nil}--#{password}--")
	end
end
